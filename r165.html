<html>
<head>
<title>Gakken GMC-4 / R-165 / Radio Shack Science Fair Microcomputer Trainer Assembler</title>
</head>
<form method="post" action="javascript:go()">
 <textarea id="source" cols=50 rows=30></textarea><br>
 <input type=submit value="Assemble">
 <br/><br/>
 Machine code: <input id="mc" size=80 readonly></textarea><br>
</form>
<br>
<p>
<h2>Example:</h2>
<pre>
START: TIA F ; put F into A register
 AO           ; display value of A register
 CAL SHTS     ; play short beep (can omit "CAL")
 JUMP START   ; restart if flag set
 JUMP #01     ; go to second command in code (flag was set by first JUMP)
</pre>
</p>
<p>
<p>
<h2>Quick Reference:</h2>
<p>All opcodes set flag except in the circumstances mentioned.</p>
<p>Source here.</p>
<ul>
<li><code>KA</code> (0): hex key&rarr;Ar and flag clear if hex key pressed</li>
<li><code>AO</code> (1): display Ar on 7-seg LED</li>
<li><code>CH</code> (2): Ar&harr;Br, Y&harr;Z</li>
<li><code>CY</code> (3): Ar&harr;Yr</li>
<li><code>AM</code> (4): Ar&rarr;[50+Yr]</li>
<li><code>MA</code> (5): [50+Yr]&rarr;Ar</li>
<li><code>M+</code> (6): [50+Yr]+A&rarr;Ar; flag clear if no overflow</li>
<li><code>M-</code> (7): [50+Yr]-A&rarr;Ar; flag clear if no underflow</li>
<li><code>TIA x</code> (8x): x&rarr;Ar (immediate x)</li>
<li><code>AIA x</code> (9x): Ar+x&rarr;Ar (immediate x); flag clear if no overflow</li>
<li><code>TIY x</code> (Ax): x&rarr;Y (immediate x)</li>
<li><code>AIY x</code> (Bx): Ar+x&rarr;Yr (immediate x); flag clear if no overflow</li>
<li><code>CIA x</code> (Cx): flag clear if x=Ar (immediate x)</li>
<li><code>CIY x</code> (Dx): flag clear if x=Yr (immediate x)</li>
<li><code>JUMP xy</code> (Fxy): jump to xy if flag set</li>
<li><code>CAL RSTO</code> (E0): clear 7-seg LED</li>
<li><code>CAL SETR</code> (E1): turn on LED #Yr</li>
<li><code>CAL RSTR</code> (E2): turn off LED #Yr</li>
<li><code>CAL CMPL</code> (E4): bitwise complement Ar</li>
<li><code>CAL CHNG</code> (E5): Ar/Br/Yr/Zr&harr;A'r/B'r/Y'r/Z'r</li>
<li><code>CAL SIFT</code> (E6): right shift Ar; flag clear if Ar was odd (!)</li>
<li><code>CAL ENDS</code> (E7): end sound</li>
<li><code>CAL ERRS</code> (E8): error sound</li>
<li><code>CAL SHTS</code> (E9): short sound</li>
<li><code>CAL LONS</code> (EA): long sound</li>
<li><code>CAL SUND</code> (EB): play note in Ar (from 1 to E)</li>
<li><code>CAL TIMR</code> (EC): delay (Ar+1)*0.1 sec.</li>
<li><code>CAL DSPR</code> (ED): display [5F][5E] on the LEDs</li>
<li><code>CAL DEM-</code> (EE): <a href="http://xl.cocolog-nifty.com/blog/2009/07/gmc-4-no-9829.html">decimal subtraction</a></li>
<li><code>CAL DEM+</code> (EF): <a href="http://xl.cocolog-nifty.com/blog/2009/07/gmc-4-no-9829.html">decimal addition</a></li>
</li>
</ul>
</body>
<script type="text/javascript">
function hex1(x) {
    return (x&0xF).toString(16).toUpperCase()
}

function hex2(x) {
    return hex1(x>>4)+hex1(x)
}

function parseHex1(x,strict=false) {
    var sign = 1
    if (!strict) {
        if (x.length > 1 && x[0] == '#') {
            x = x.substr(1)
        }
        if (x.length > 1 && x[0] == '-') {
            sign = -1
            x = x.substr(1)
        }
    }
    if (x.length == 1 && ('0'<=x && x<='9') || ('a' <= x && x <= 'f') || ('A' <= x && x <= 'A'))
        return sign * parseInt("0x"+x)
    else
        return null
}

function parseHex2(x) {
    if (x.length == 1) {
        return parseHex1(x,strict=true)
    }
    else if (x.length == 2) {
        var a = parseHex1(x[0],strict=true)
        if (a === null) {
            return null
        }
        var b = parseHex2(x[1],strict=true)
        if (b === null) {
            return null
        }
        return (a<<4)|b
    }
    else {
        return null
    }
}

function assemble(input, output) {
    var labels = {}
    var lines = input.split(/[\r\n]+/)
    var extended = { rsto: "0", setr: "1", rstr: "2", cmpl: "4", chng: "5", sift: "6", ends: "7",
                     errs: "8", shts: "9", lons: "A", sund: "B", timr: "C", dspr: "D", "dem-": "E", "dem+": "F" }
    output.value = ""
    var out = ""
    
    for (var i=0; i<lines.length; i++) {
        err = function(msg) {
            alert(msg+" ["+lines[i]+"]")
        }
    
        var line = lines[i].replace(/;.*/,"").trim()
        if (line == "")
            continue
        var tokens = line.split(/\s+/)
        if (tokens.length == 0)
            continue
        var pos = 0
        while (pos < tokens.length && tokens[pos].endsWith(":")) {
            var label = tokens[0].substr(0,tokens[0].length-1)
            var targetPos = out.length
            if (label in labels) {
                labels[label].target = targetPos
                refs = labels[label].refs
                for (var j = 0 ; j < refs.length ; j++) {
                    var r = refs[j]
                    out = out.substr(0,r)+hex2(targetPos)+out.substr(r+2)
                }
                labels[label].refs = []
            }
            else {
                labels[label] = { target: targetPos, refs: [] }
            }
            pos++
        }
        if (pos < tokens.length) {
            var token = tokens[pos].toLowerCase()
            switch(token) {
                case "ka":
                    out += "0"
                    break
                case "ao":
                    out += "1"
                    break
                case "ch":
                    out += "2"
                    break
                case "cy":
                    out += "3"
                    break
                case "am":
                    out += "4"
                    break
                case "ma":
                    out += "5"
                    break
                case "m+":
                    out += "6"
                    break
                case "m-":
                    out += "7"
                    break
                case "tia":
                    if (pos + 1 >= tokens.length) {
                        err("TIA needs value")
                        return
                    }
                    out += "8"
                    var x = parseHex1(tokens[pos+1])
                    if (x === null) {
                        err("invalid hex constant")
                        return
                    }
                    out += hex1(x)
                    break
                case "aia":
                    if (pos + 1 >= tokens.length) {
                        err("AIA needs value")
                        return
                    }
                    out += "9"
                    var x = parseHex1(tokens[pos+1])
                    if (x === null) {
                        err("invalid hex constant")
                        return
                    }
                    out += hex1(x)
                    break
                case "tiy":
                    if (pos + 1 >= tokens.length) {
                        err("TIY needs value")
                        return
                    }
                    out += "A"
                    var x = parseHex1(tokens[pos+1])
                    if (x === null) {
                        err("invalid hex constant")
                        return
                    }
                    out += hex1(x)
                    break
                case "aiy":
                    if (pos + 1 >= tokens.length) {
                        err("TIY needs value")
                        return
                    }
                    out += "B"
                    var x = parseHex1(tokens[pos+1])
                    if (x === null) {
                        err("invalid hex constant")
                        return
                    }
                    out += hex1(x)
                    break
                case "cia":
                    if (pos + 1 >= tokens.length) {
                        err("CIA needs value")
                        return
                    }
                    out += "C"
                    var x = parseHex1(tokens[pos+1])
                    if (x === null) {
                        err("invalid hex constant")
                        return
                    }
                    out += hex1(x)
                    break
                case "ciy":
                    if (pos + 1 >= tokens.length) {
                        err("CIY needs value")
                        return
                    }
                    out += "D"
                    var x = parseHex1(tokens[pos+1])
                    if (x === null) {
                        err("invalid hex constant")
                        return
                    }
                    out += hex1(x)
                    break
                case "cal":
                    if (pos + 1 >= tokens.length || !(tokens[pos+1].toLowerCase() in extended)) {
                        err("CAL needs valid extended code")
                        return
                    }
                    out += "E" + extended[tokens[pos+1].toLowerCase()]
                    break
                case "jump": 
                    if (pos + 1 >= tokens.length) {
                        err("JUMP needs target")
                        return
                    }
                    target = tokens[pos+1]
                    out += "F"
                    var targetPos
                    if (target[0] == '#') {
                        targetPos = parseHex2(target.substr(1))
                        if (targetPos === null) {
                            alert("Invalid hex constant")
                            return
                        }
                    }
                    else {
                        if (target in labels) {
                            if ("target" in labels[target]) {
                                targetPos = labels[target].target
                            }
                            else {
                                targetPos = parseHex2(target)
                                labels[target].refs.push(out.length)
                            }
                        }
                        else {
                            targetPos = parseHex2(target)
                            labels[target] = { refs: [out.length] }
                        }
                    }
                    out += hex2(targetPos===null?0:targetPos)
                    break;
                default:
                    if (token in extended) {
                        out += "E" + extended[token]
                        break
                    }
                    err("unrecognized opcode")
                    return
            }
        }
    }
    for (var label in labels) {
        if (labels[label].refs.length && parseHex2(label)===null) {
            alert("Unresolved label "+label)
        }
    }
    output.value=out
}

function go() {
    assemble(document.getElementById('source').value, document.getElementById('mc'))
}
</script>
</html>
